# Instructions for creating a custom FL workload

EdgeFL is designed to simplify all aspects of federated learning, including
model sharing, orchestration, and node synchronization. Specifically,
all a user needs to do is define node configuration files that defines
the necessary environment variables required by their training application, 
often referenced by the term `data handler`, that provides:
- The model definition
- Training algorithm (including SQL queries)
- Aggregation algorithm
- Inference algorithm

## Node configuration files
Each training or aggregation node needs the following configurations that are utilized
by EdgeFL and the training application as environment variables. Thus, these environment
variables are a non-exhaustive list, just the minimum required: feel free to include any environment variables 
needed in your training application. 
```bash
# The directory in which the EdgeFL repo is located
GITHUB_DIR=/Users/roy/Github-Repos/EdgeFL

# The directory where the data handler is written to
TRAINING_APPLICATION_DIR=edgefl/platform_components/data_handlers

# The data handler class name
MODULE_NAME=[ClassName]

# The data handler file name
MODULE_FILE=[FileName]

# Temporary directory used to move files from container to local system
TMP_DIR=edgefl/tmp_dir/
# External IP Address for CURL commands to Edgelake
EXTERNAL_IP=[EdgeLake node IP:REST_PORT]
EXTERNAL_TCP_IP_PORT=[EdgeLake node IP:TCP_PORT]

# Logical database name
LOGICAL_DATABASE=[DBMS_Name]

# Table containing trained data (specific to your setup)
TRAIN_TABLE=Table 
# Table containing test data (specific to your setup)
TEST_TABLE=xray_test

# Directory each node uses to write to
FILE_WRITE_DESTINATION="edgefl/file_write"

# True if EdgeLake running as a docker container 
EDGELAKE_DOCKER_RUNNING="True"
# Specify the docker container name
EDGELAKE_DOCKER_CONTAINER_NAME=[EdgeLake Docker Container Name]
DOCKER_FILE_WRITE_DESTINATION="/app/file_write"
```

## Data Handler Template
The data handler is a file that contains a class object. This class object defines certain functions
that EdgeFL depends on to execute training, aggregation, inference, and weight transmission. 

The following psuedocode includes function names must be defined. I've included a short descriptions of each
function's input arguments, expected return value, and functionality. Feel free to add additional supportive
functions as needed. 

```python
"""
This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/
"""

# import ast
import os
import logging
import numpy as np
import requests
from platform_components.lib.modules.local_model_update import LocalModelUpdate
from platform_components.model_fusion_algorithms.FedAvg import FedAvg_aggregate
from platform_components.lib.logger.logger_config import configure_logging
logger = logging.getLogger(__name__)

####### Import all required ML libraries #########
# Tensorflow
# Keras
# Scipy
##################################################


####### Import all all env variables #########

# node that system_query resides on
QUERY_NODE_URL=f"http://{os.getenv('EXTERNAL_IP')}"
# Edge Node containing data
EDGE_NODE_URL=os.getenv('EXTERNAL_TCP_IP_PORT', 'network')
##################################################


class YourDataHandlerClassName():
    def __init__(self, node_name, db_name):
        """
        Initialize.

        Args:
            node_name: Automatically generated by EdgeFL            
            **kwargs: Additional arguments, passed to super init and load_mnist_shard
        """
        # configure_logging(f"node_server_{port}")
        configure_logging("node_server_data_handler")
        self.logger = logging.getLogger(__name__)
        self.tcp_ip_port = os.getenv("EXTERNAL_TCP_IP_PORT")
        self.edgelake_node_url = f'http://{os.getenv("EXTERNAL_IP")}'
        
        #### Any additional logic you want the training node to do on startup
    
    def model_def(self):
        # Define the model infrastructure
        # Return the model object

    
    def get_weights(self):
        # Function that returns the model's weights
        # Return model weights as np.array

    
    def update_model(self, weights):
        # Update model with new weights
        # Return, no requirement

    def train(self, round_number):
        # Define model training algorithm. Within this function, you need to define the EdgeLake operator query.
        # Return the model weights using `self.get_weights()`
        

    def aggregate_model_weights(self, weights):
        # Define aggregation algorithm. FedAvg is provided by EdgeFL. Example below. 
        aggregated_params = FedAvg_aggregate(weights)
        return aggregated_params

    def direct_inference(self, data):
        """
        Run inference on raw input data against given labels (already in WINNIIO format).
        Handles data conversion and validation internally.
        """
        # Given an input data, define the prediction/inference and return the prediction.
        # Return the prediction


    def run_inference(self):
        # Function intended for evaluating the model. 
        # There's no input, but feel free to add any logic
        # Return whatever you want.

```
